<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DropAndPush ($DNP) - The Meme Coin for Crypto Warriors</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* Пользовательские стили и шрифты */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Темно-синий фон */
        }
        .font-fredoka {
            font-family: 'Fredoka One', cursive;
        }
        /* Анимация свечения для кнопок и ярких элементов */
        .glow-effect {
            box-shadow: 0 0 5px #a8ff78, 0 0 15px #a8ff78, 0 0 25px #a8ff78, 0 0 35px #a8ff78;
        }
        /* Стили для модальных окон */
        .modal-backdrop {
            background-color: rgba(0,0,0,0.7);
        }
        /* Стили для полноэкранной игры */
        #game-viewport {
            background-image: url('images/fon.png');
            background-size: cover;
            background-position: center;
        }
        #candle-char-container {
            cursor: pointer;
            user-select: none; /* Отключить выделение изображения при быстрых кликах */
            -webkit-user-drag: none; /* Отключить перетаскивание */
        }
        #candle-char-container:active #candle-char {
            transform: scale(0.95);
        }
        #candle-char {
             transition: transform 0.1s ease-out;
        }
        .coin-animation {
            animation: coin-fly 0.7s ease-out forwards;
        }
        @keyframes coin-fly {
            0% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
            100% { transform: translate(250px, -250px) scale(0); opacity: 0; }
        }
        #power-bar-fill {
            transition: height 0.1s linear;
        }
    </style>
</head>
<body class="text-white">

    <!-- Навигационная панель -->
    <nav class="bg-[#1e1e3f]/80 backdrop-blur-sm sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <a href="#" class="font-fredoka text-xl md:text-2xl text-white">Drop<span class="text-[#a8ff78]">And</span>Push</a>
                </div>
                <div id="auth-links" class="flex items-center">
                     <button id="connect-wallet-btn" class="bg-[#a8ff78] hover:bg-green-400 text-gray-900 font-bold py-2 px-3 md:px-4 text-sm md:text-base rounded-lg transition glow-effect flex items-center space-x-2">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22ZM11.4111 12.0125L11.4087 12.0101L11.4055 12.007L11.4016 12.0031C11.3323 11.9332 11.2753 11.8341 11.2753 11.7288V7.54518C11.2753 7.33764 11.517 7.21443 11.6836 7.32018L15.3414 9.61199C15.5097 9.71884 15.5097 9.96752 15.3414 10.0744L11.6836 12.3662C11.517 12.4719 11.2753 12.3487 11.2753 12.1412V12.1412V12.0125H11.4111ZM11.4111 12.0125V16.6346C11.4111 16.8421 11.1694 16.9653 11.0028 16.8596L7.34499 14.5678C7.17666 14.4609 7.17666 14.2123 7.34499 14.1054L11.0028 11.8136C11.1694 11.7079 11.4111 11.8311 11.4111 12.0386V12.0125Z" fill="currentColor"/></svg>
                        <span>Connect Wallet</span>
                    </button>
                </div>
                <div id="user-profile" class="hidden items-center space-x-2 md:space-x-4">
                     <span id="user-display" class="hidden sm:inline bg-gray-700/50 text-gray-300 text-sm font-mono px-3 py-1 rounded-md"></span>
                    <button id="profile-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-3 md:px-4 text-sm md:text-base rounded-lg transition">Profile</button>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 md:px-4 text-sm md:text-base rounded-lg transition">Logout</button>
                </div>
            </div>
        </div>
    </nav>


    <!-- Основной контейнер страницы -->
    <div class="container mx-auto p-4 md:p-8">

        <!-- ======== Блок Hero: Название и Логотип ======== -->
        <header class="text-center py-8 md:py-12">
            <img src="images/logo.png" alt="DropAndPush Logo" class="mx-auto mb-6 w-40 h-40 md:w-64 md:h-64 rounded-full border-4 border-[#a8ff78] glow-effect object-contain">
            <h1 class="font-fredoka text-5xl md:text-7xl lg:text-8xl text-white drop-shadow-lg">
                Drop<span class="text-[#a8ff78]">And</span>Push
            </h1>
            <p class="font-fredoka text-2xl md:text-3xl text-yellow-300 mt-2">$DNP</p>
            <p class="mt-6 text-lg md:text-2xl font-bold text-gray-300 max-w-xl mx-auto">
                When life drops, just Push!
            </p>
        </header>

        <main class="space-y-12 md:space-y-16">
            <!-- ======== Блок с игрой (виден только авторизованным) ======== -->
            <section id="game-section" class="hidden text-center bg-purple-900/50 p-6 md:p-10 rounded-2xl shadow-lg border-2 border-purple-500">
                <h2 class="font-fredoka text-3xl md:text-5xl text-white mb-2">The DNP Gym is Open!</h2>
                <p class="text-lg md:text-xl text-gray-300 font-semibold mb-6">Your training starts now.</p>
                <button id="start-game-btn" class="bg-green-500 hover:bg-green-600 text-white font-fredoka text-xl md:text-2xl px-10 py-3 rounded-full transition transform hover:scale-105 glow-effect">
                    Start Training
                </button>
            </section>
        
            <!-- ======== Блок Описания ======== -->
            <section id="about" class="bg-[#1e1e3f] p-6 md:p-8 rounded-2xl shadow-lg border-2 border-purple-500 transform hover:scale-105 transition-transform duration-300">
                <h2 class="font-fredoka text-3xl md:text-4xl text-center mb-4 text-[#a8ff78]">Meme coin for crypto warriors!</h2>
                <p class="text-base md:text-lg text-gray-300 leading-relaxed text-center max-w-3xl mx-auto">
                    Whenever the price drops, don’t panic — do a push-up and bounce back.
                </p>
                <div class="text-center mt-6 font-bold text-yellow-300 text-sm md:text-lg flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-2">
                    <span>100% MEME-POWERED</span>
                    <span class="hidden sm:inline">|</span>
                    <span>ZERO UTILITY</span>
                     <span class="hidden sm:inline">|</span>
                    <span>PURE FUN</span>
                </div>
            </section>

            <!-- ======== Блок Технических Деталей (Токеномика) ======== -->
            <section id="tokenomics" class="bg-[#2a2a4e] p-6 md:p-8 rounded-2xl shadow-lg border-2 border-yellow-400 transform hover:scale-105 transition-transform duration-300">
                <h2 class="font-fredoka text-3xl md:text-4xl text-center mb-6 text-yellow-300">Technical Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 max-w-2xl mx-auto text-base md:text-lg">
                    <div class="bg-gray-800/50 p-4 rounded-lg flex justify-between items-center">
                        <span class="font-bold text-gray-400">Name:</span>
                        <span class="font-mono text-[#a8ff78]">DropAndPush</span>
                    </div>
                    <div class="bg-gray-800/50 p-4 rounded-lg flex justify-between items-center">
                        <span class="font-bold text-gray-400">Symbol:</span>
                        <span class="font-mono text-[#a8ff78]">$DNP</span>
                    </div>
                    <div class="bg-gray-800/50 p-4 rounded-lg flex justify-between items-center">
                        <span class="font-bold text-gray-400">Chain:</span>
                        <span class="font-mono text-[#a8ff78]">Ethereum</span>
                    </div>
                    <div class="bg-gray-800/50 p-4 rounded-lg flex justify-between items-center">
                        <span class="font-bold text-gray-400">Total supply:</span>
                        <span class="font-mono text-[#a8ff78]">1,000,000,000</span>
                    </div>
                </div>
            </section>

            <!-- ======== Дорожная карта (Roadmap) ======== -->
            <section id="roadmap" class="bg-[#1e1e3f] p-6 md:p-8 rounded-2xl shadow-lg border-2 border-cyan-400 transform hover:scale-105 transition-transform duration-300">
                <h2 class="font-fredoka text-3xl md:text-4xl text-center mb-10 text-cyan-300">Roadmap: The Training Plan</h2>
                <!-- Mobile Roadmap -->
                <div class="md:hidden space-y-8">
                    <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0 bg-cyan-500 w-10 h-10 rounded-full flex items-center justify-center font-black text-lg text-white">1</div>
                        <div>
                            <h3 class="font-bold text-white text-lg">Phase 1: The Warm-up</h3>
                            <p class="text-sm text-gray-300">Website & Socials Launch, Litepaper Release.</p>
                        </div>
                    </div>
                     <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0 bg-purple-500 w-10 h-10 rounded-full flex items-center justify-center font-black text-lg text-white">2</div>
                        <div>
                            <h3 class="font-bold text-white text-lg">Phase 2: Strength Building</h3>
                            <p class="text-sm text-gray-300">Community Growth, Meme Contests, Token Smart Contract Deployment.</p>
                        </div>
                    </div>
                     <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0 bg-cyan-500 w-10 h-10 rounded-full flex items-center justify-center font-black text-lg text-white">3</div>
                        <div>
                            <h3 class="font-bold text-white text-lg">Phase 3: Max Reps</h3>
                            <p class="text-sm text-gray-300">Public Token Sale, Listing on Uniswap, First Marketing Push.</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0 bg-purple-500 w-10 h-10 rounded-full flex items-center justify-center font-black text-lg text-white">4</div>
                        <div>
                            <h3 class="font-bold text-white text-lg">Phase 4: To the Moon!</h3>
                            <p class="text-sm text-gray-300">Listing on CoinGecko & CoinMarketCap, Influencer Collaborations.</p>
                        </div>
                    </div>
                </div>

                <!-- Desktop Roadmap -->
                <div class="hidden md:block relative max-w-2xl mx-auto">
                    <div class="absolute left-1/2 top-0 h-full w-1 bg-gray-700/50 transform -translate-x-1/2"></div>
                    <div class="mb-8 flex justify-between items-center w-full right-timeline">
                        <div class="order-1 w-5/12"></div>
                        <div class="z-10 flex items-center order-1 bg-cyan-500 shadow-xl w-12 h-12 rounded-full">
                            <h1 class="mx-auto font-black text-lg text-white">1</h1>
                        </div>
                        <div class="order-1 bg-gray-800 rounded-lg shadow-xl w-5/12 px-6 py-4">
                            <h3 class="font-bold text-white text-xl">Phase 1: The Warm-up</h3>
                            <p class="text-sm leading-snug tracking-wide text-gray-300 text-opacity-100">Website & Socials Launch, Litepaper Release.</p>
                        </div>
                    </div>
                    <div class="mb-8 flex justify-between flex-row-reverse items-center w-full left-timeline">
                        <div class="order-1 w-5/12"></div>
                        <div class="z-10 flex items-center order-1 bg-purple-500 shadow-xl w-12 h-12 rounded-full">
                            <h1 class="mx-auto text-white font-black text-lg">2</h1>
                        </div>
                        <div class="order-1 bg-purple-800 rounded-lg shadow-xl w-5/12 px-6 py-4">
                            <h3 class="font-bold text-white text-xl">Phase 2: Strength Building</h3>
                            <p class="text-sm leading-snug tracking-wide text-gray-300 text-opacity-100">Community Growth, Meme Contests, Token Smart Contract Deployment.</p>
                        </div>
                    </div>
                     <div class="mb-8 flex justify-between items-center w-full right-timeline">
                        <div class="order-1 w-5/12"></div>
                        <div class="z-10 flex items-center order-1 bg-cyan-500 shadow-xl w-12 h-12 rounded-full">
                            <h1 class="mx-auto font-black text-lg text-white">3</h1>
                        </div>
                        <div class="order-1 bg-gray-800 rounded-lg shadow-xl w-5/12 px-6 py-4">
                            <h3 class="font-bold text-white text-xl">Phase 3: Max Reps</h3>
                            <p class="text-sm leading-snug tracking-wide text-gray-300 text-opacity-100">Public Token Sale, Listing on Uniswap, First Marketing Push.</p>
                        </div>
                    </div>
                    <div class="mb-8 flex justify-between flex-row-reverse items-center w-full left-timeline">
                        <div class="order-1 w-5/12"></div>
                        <div class="z-10 flex items-center order-1 bg-purple-500 shadow-xl w-12 h-12 rounded-full">
                            <h1 class="mx-auto text-white font-black text-lg">4</h1>
                        </div>
                        <div class="order-1 bg-purple-800 rounded-lg shadow-xl w-5/12 px-6 py-4">
                            <h3 class="font-bold text-white text-xl">Phase 4: To the Moon!</h3>
                            <p class="text-sm leading-snug tracking-wide text-gray-300 text-opacity-100">Listing on CoinGecko & CoinMarketCap, Influencer Collaborations.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ======== Блок Предзаказа (Call to Action) ======== -->
            <section id="preorder" class="text-center bg-gradient-to-r from-green-400 to-yellow-500 p-8 md:p-10 rounded-2xl shadow-lg transform hover:scale-105 transition-transform duration-300">
                <h2 class="font-fredoka text-3xl md:text-5xl text-gray-900 mb-4">Pre-order DNP tokens now!</h2>
                <p class="text-lg md:text-xl text-gray-800 font-semibold mb-6">Join the movement, join the bounce!</p>
                <button class="bg-gray-900 text-white font-fredoka text-xl md:text-2xl px-10 py-3 md:px-12 md:py-4 rounded-full hover:bg-black transform hover:rotate-[-5deg] transition-all duration-300 glow-effect">
                    GET $DNP
                </button>
            </section>
        </main>

        <!-- ======== Футер и Контакты ======== -->
        <footer class="text-center mt-12 md:mt-16 py-8">
            <h3 class="font-fredoka text-xl md:text-2xl mb-4 text-gray-300">Find us here:</h3>
            <div class="flex justify-center space-x-6">
                <!-- Telegram -->
                <a href="https://t.me/DropNpushCoin" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transform hover:scale-125 transition-transform">
                    <svg class="w-8 h-8 md:w-10 md:h-10" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M9.78 18.65l.28-4.23l7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3L3.64 12c-.88-.25-.89-.86.2-1.3l15.97-6.16c.73-.33 1.43.18 1.15 1.3l-2.72 12.81c-.19.91-.74 1.13-1.51 .71l-4.84-3.56l-2.31 2.24c-.25.24-.45.44-.88.44l.28-4.23z"/></svg>
                </a>
                <!-- Email -->
                <a href="mailto:dnp.official.contact@proton.me" class="text-gray-400 hover:text-white transform hover:scale-125 transition-transform">
                    <svg class="w-8 h-8 md:w-10 md:h-10" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z"/></svg>
                </a>
            </div>
            <p class="text-xs md:text-sm text-gray-500 mt-8">&copy; 2025 DropAndPush Coin. All rights reserved. For entertainment purposes only.</p>
        </footer>
    </div>
    
    <!-- Profile Modal -->
    <div id="profile-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4">
        <div class="bg-[#2a2a4e] p-6 md:p-8 rounded-2xl shadow-lg w-full max-w-md border-2 border-green-400 relative">
             <button class="close-modal-btn absolute top-2 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h2 class="font-fredoka text-2xl md:text-3xl text-center mb-4 text-white">Your Profile</h2>
            <div id="profile-content">
                 <div class="mb-4">
                    <label class="block text-gray-300 mb-2">Connected Wallet</label>
                    <p id="profile-wallet" class="text-lg text-green-400 font-mono break-words bg-gray-800/50 p-3 rounded-lg"></p>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-300 mb-2">Total Score</label>
                    <p id="profile-score" class="text-2xl font-fredoka text-yellow-300"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Overlay -->
    <div id="game-overlay" class="hidden fixed inset-0 z-[100] bg-black/80 flex items-center justify-center p-4">
        <div id="game-viewport" class="relative w-full h-full max-h-[90vh] aspect-[9/16] mx-auto rounded-lg">
            <!-- Game UI -->
            <div class="absolute top-4 left-4 z-10">
                <button id="close-game-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">Exit</button>
            </div>
            <div class="absolute top-4 right-4 z-10 bg-black/50 p-2 rounded-lg flex items-center space-x-2">
                <img src="images/gold.png" alt="Coin" class="w-8 h-8">
                <span id="game-score" class="font-fredoka text-2xl text-yellow-300">0</span>
            </div>

            <!-- Game Area -->
            <div id="candle-char-container" class="w-full h-full flex items-end justify-center pb-16">
                 <!-- Power Bar -->
                <div class="absolute left-4 bottom-16 h-1/2 w-8 bg-gray-900/50 rounded-full border-2 border-gray-500 flex flex-col-reverse overflow-hidden">
                    <div id="power-bar-fill" class="w-full bg-gradient-to-t from-red-500 via-yellow-500 to-green-500" style="height: 0%;"></div>
                </div>
                
                <img id="candle-char" src="images/fire_red.png" alt="Candle Character" class="h-1/2">
            </div>
            <div id="coin-animation-container" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
        </div>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signOut, 
            onAuthStateChanged,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            updateDoc,
            increment,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIG OBJECT HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAWgflsjln12yVOQZInvFql97bFHs8aO7c",
            authDomain: "dropandpush-coin.firebaseapp.com",
            projectId: "dropandpush-coin",
            storageBucket: "dropandpush-coin.firebasestorage.app",
            messagingSenderId: "414577803061",
            appId: "1:414577803061:web:1e44ab43730ebb0702967c"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI Elements
        const connectWalletBtn = document.getElementById('connect-wallet-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const profileBtn = document.getElementById('profile-btn');
        
        const authLinks = document.getElementById('auth-links');
        const userProfile = document.getElementById('user-profile');
        const userDisplay = document.getElementById('user-display');
        const gameSection = document.getElementById('game-section');

        const profileModal = document.getElementById('profile-modal');
        
        // Game Elements
        const startGameBtn = document.getElementById('start-game-btn');
        const gameOverlay = document.getElementById('game-overlay');
        const closeGameBtn = document.getElementById('close-game-btn');
        const candleCharContainer = document.getElementById('candle-char-container');
        const candleChar = document.getElementById('candle-char');
        const gameScoreDisplay = document.getElementById('game-score');
        const coinAnimationContainer = document.getElementById('coin-animation-container');
        const powerBarFill = document.getElementById('power-bar-fill');

        let currentUser = null;
        let userDocRef = null;
        let scoreUnsubscribe = null; 

        // --- Modal & Overlay Logic ---
        function showModal(modal) { modal.classList.remove('hidden'); }
        function hideModal(modal) { modal.classList.add('hidden'); }

        startGameBtn.addEventListener('click', () => {
            gameOverlay.classList.remove('hidden');
            startGameLoop();
        });
        closeGameBtn.addEventListener('click', () => {
            gameOverlay.classList.add('hidden');
            stopGameLoop();
        });

        profileBtn.addEventListener('click', async () => {
            if (!currentUser) return;
            
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('profile-wallet').textContent = data.wallet || 'N/A';
                document.getElementById('profile-score').textContent = data.score || 0;
            }
            showModal(profileModal);
        });
        
        document.querySelectorAll('.modal-backdrop, .close-modal-btn').forEach(el => {
            el.addEventListener('click', (e) => {
                 if (e.target.classList.contains('close-modal-btn')) {
                    el.closest('.modal-backdrop').classList.add('hidden');
                }
            })
        });

        // --- Wallet Logic ---
        function formatAddress(address) {
            if (!address) return '';
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        connectWalletBtn.addEventListener('click', async () => {
            if (typeof window.ethereum === 'undefined') {
                alert('MetaMask is not installed. Please install it to use this feature.');
                return;
            }
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                await signInAnonymously(auth);
            } catch (error) {
                 console.error("Wallet connection failed:", error);
                if (error.code === 4001) {
                    alert('Connection request rejected. Please approve the request in MetaMask to connect your wallet.');
                } else {
                    alert(`Failed to connect wallet. Please see console for details.`);
                }
            }
        });

        // --- Game Logic ---
        let powerLevel = 0;
        const MAX_POWER = 100;
        const POWER_PER_TAP = 10;
        const POWER_DECREASE_RATE = 1;
        let gameLoopInterval = null;
        
        const candleStates = ['images/fire_red.png', 'images/fire_yellow.png', 'images/fire_green.png'];

        function updateGameUI() {
            powerBarFill.style.height = `${powerLevel}%`;

            if (powerLevel < 40) candleChar.src = candleStates[0];
            else if (powerLevel < 80) candleChar.src = candleStates[1];
            else candleChar.src = candleStates[2];
        }

        function startGameLoop() {
            if (gameLoopInterval) return;
            gameLoopInterval = setInterval(() => {
                powerLevel = Math.max(0, powerLevel - POWER_DECREASE_RATE);
                updateGameUI();
            }, 50); // Decrease power every 50ms
        }

        function stopGameLoop() {
            clearInterval(gameLoopInterval);
            gameLoopInterval = null;
            powerLevel = 0;
            updateGameUI();
        }
        
        candleCharContainer.addEventListener('click', async () => {
            if (!currentUser) return;

            powerLevel = Math.min(MAX_POWER, powerLevel + POWER_PER_TAP);

            if (powerLevel >= MAX_POWER) {
                powerLevel = 0; // Reset bar

                try {
                    await updateDoc(userDocRef, { score: increment(1) });
                
                    const coinImg = document.createElement('img');
                    coinImg.src = 'images/gold.png';
                    coinImg.className = 'w-12 h-12 absolute coin-animation';
                    coinAnimationContainer.appendChild(coinImg);
                    setTimeout(() => coinImg.remove(), 700);
                } catch (error) {
                    console.error("Error updating score:", error);
                }
            }
            updateGameUI();
        });


        // --- Auth State Logic ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
             if (scoreUnsubscribe) {
                scoreUnsubscribe(); // Detach old listener
            }

            if (user && user.isAnonymous) {
                userDocRef = doc(db, "users", user.uid);
                
                const docSnap = await getDoc(userDocRef);
                
                if (!docSnap.exists()) {
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                        if (accounts.length > 0) {
                             await setDoc(userDocRef, {
                                wallet: accounts[0],
                                score: 0,
                                createdAt: new Date()
                            });
                        } else {
                             signOut(auth);
                             return;
                        }
                    } catch(e) {
                        console.error("Could not get accounts for new user setup", e);
                        signOut(auth);
                        return;
                    }
                }
                
                // Real-time listener for score
                scoreUnsubscribe = onSnapshot(userDocRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        userDisplay.textContent = formatAddress(data.wallet);
                        gameScoreDisplay.textContent = data.score || 0;

                        authLinks.classList.add('hidden');
                        userProfile.classList.remove('hidden');
                        userProfile.classList.add('flex');
                        gameSection.classList.remove('hidden');
                    }
                });

            } else {
                // User is signed out
                authLinks.classList.remove('hidden');
                userProfile.classList.add('hidden');
                userProfile.classList.remove('flex');
                gameSection.classList.add('hidden');
                currentUser = null;
                userDocRef = null;
                stopGameLoop();
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
        });

    </script>

</body>
</html>

