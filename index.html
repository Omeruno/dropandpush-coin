<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DropAndPush ($DNP) - The Meme Coin for Crypto Warriors</title>
    
    <!-- Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* Пользовательские стили и шрифты */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Темно-синий фон */
        }
        .font-fredoka {
            font-family: 'Fredoka One', cursive;
        }
        /* Анимация свечения для кнопок и ярких элементов */
        .glow-effect {
            box-shadow: 0 0 5px #a8ff78, 0 0 15px #a8ff78, 0 0 25px #a8ff78, 0 0 35px #a8ff78;
        }
        /* Стили для модальных окон */
        .modal-backdrop {
            background-color: rgba(0,0,0,0.7);
        }
        /* Стили для полноэкранной игры */
        #game-viewport {
            background-image: url('images/fon.png');
            background-size: cover;
            background-position: center bottom;
            background-repeat: no-repeat;
        }
        #candle-char-container {
            cursor: pointer;
            user-select: none;
            -webkit-user-drag: none;
        }
        #candle-char-container:active #candle-char {
            transform: scale(0.95);
        }
        #candle-char {
             transition: transform 0.1s ease-out;
             animation: idle-breath 3s ease-in-out infinite;
        }
        .plus-one-animation {
            animation: plus-one-fly 1s ease-out forwards;
        }
        .motivation-animation {
            animation: fade-in-out 4s ease-in-out forwards;
        }
        .bonus-popup-animation {
            animation: bonus-fade-in-out 3s ease-in-out forwards;
        }

        @keyframes idle-breath {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        @keyframes plus-one-fly {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-80px) scale(1.5); opacity: 0; }
        }
        @keyframes fade-in-out {
            0%, 100% { opacity: 0; transform: translateY(10px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
        @keyframes bonus-fade-in-out {
            0%, 100% { opacity: 0; transform: translateY(20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
        #power-bar-fill {
            transition: height 0.1s linear;
        }
    </style>
</head>
<body class="text-white">

    <!-- Навигационная панель --><nav class="bg-[#1e1e3f]/80 backdrop-blur-sm sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <a href="#" class="font-fredoka text-xl md:text-2xl text-white">Drop<span class="text-[#a8ff78]">And</span>Push</a>
                </div>
                <div id="auth-links" class="flex items-center">
                     <button id="connect-wallet-btn" class="bg-[#a8ff78] hover:bg-green-400 text-gray-900 font-bold py-2 px-3 md:px-4 text-sm md:text-base rounded-lg transition glow-effect flex items-center space-x-2">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22ZM11.4111 12.0125L11.4087 12.0101L11.4055 12.007L11.4016 12.0031C11.3323 11.9332 11.2753 11.8341 11.2753 11.7288V7.54518C11.2753 7.33764 11.517 7.21443 11.6836 7.32018L15.3414 9.61199C15.5097 9.71884 15.5097 9.96752 15.3414 10.0744L11.6836 12.3662C11.517 12.4719 11.2753 12.3487 11.2753 12.1412V12.1412V12.0125H11.4111ZM11.4111 12.0125V16.6346C11.4111 16.8421 11.1694 16.9653 11.0028 16.8596L7.34499 14.5678C7.17666 14.4609 7.17666 14.2123 7.34499 14.1054L11.0028 11.8136C11.1694 11.7079 11.4111 11.8311 11.4111 12.0386V12.0125Z" fill="currentColor"/></svg>
                        <span>Connect Wallet</span>
                    </button>
                </div>
                <div id="user-profile" class="hidden items-center space-x-2 md:space-x-4">
                     <span id="user-display" class="hidden sm:inline bg-gray-700/50 text-gray-300 text-sm font-mono px-3 py-1 rounded-md"></span>
                    <button id="profile-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-3 md:px-4 text-sm md:text-base rounded-lg transition">Profile</button>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 md:px-4 text-sm md:text-base rounded-lg transition">Logout</button>
                </div>
            </div>
        </div>
    </nav>


    <!-- Основной контейнер страницы --><div class="container mx-auto p-4 md:p-8">

        <!-- ======== Блок Hero: Название и Логотип ======== --><header class="text-center py-8 md:py-12">
            <img src="images/logo.png" alt="DropAndPush Logo" class="mx-auto mb-6 w-40 h-40 md:w-64 md:h-64 rounded-full border-4 border-[#a8ff78] glow-effect object-contain">
            <h1 class="font-fredoka text-5xl md:text-7xl lg:text-8xl text-white drop-shadow-lg">
                Drop<span class="text-[#a8ff78]">And</span>Push
            </h1>
            <p class="font-fredoka text-2xl md:text-3xl text-yellow-300 mt-2">$DNP</p>
            <p class="mt-6 text-lg md:text-2xl font-bold text-gray-300 max-w-xl mx-auto">
                When life drops, just Push!
            </p>
        </header>

        <main class="space-y-12 md:space-y-16">
            <!-- ======== Блок с игрой (виден только авторизованным) ======== --><section id="game-section" class="hidden text-center bg-purple-900/50 p-6 md:p-10 rounded-2xl shadow-lg border-2 border-purple-500">
                <h2 class="font-fredoka text-3xl md:text-5xl text-white mb-2">The DNP Gym is Open!</h2>
                <p class="text-lg md:text-xl text-gray-300 font-semibold mb-6">Your training starts now.</p>
                <button id="start-game-btn" class="bg-green-500 hover:bg-green-600 text-white font-fredoka text-xl md:text-2xl px-10 py-3 rounded-full transition transform hover:scale-105 glow-effect">
                    Start Training
                </button>
                <p class="mt-6 text-base text-cyan-300 max-w-2xl mx-auto">
                    Your score in the gym will directly impact the size of your future $DNP airdrop. Train hard, warrior!
                </p>
            </section>
        
            <!-- ======== Блок Описания ======== --><section id="about" class="bg-[#1e1e3f] p-6 md:p-8 rounded-2xl shadow-lg border-2 border-purple-500 transform hover:scale-105 transition-transform duration-300">
                <h2 class="font-fredoka text-3xl md:text-4xl text-center mb-4 text-[#a8ff78]">Meme coin for crypto warriors!</h2>
                <p class="text-base md:text-lg text-gray-300 leading-relaxed text-center max-w-3xl mx-auto">
                    Whenever the price drops, don’t panic — do a push-up and bounce back.
                </p>
                <div class="text-center mt-6 font-bold text-yellow-300 text-sm md:text-lg flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-2">
                    <span>100% MEME-POWERED</span>
                    <span class="hidden sm:inline">|</span>
                    <span>ZERO UTILITY</span>
                     <span class="hidden sm:inline">|</span>
                    <span>PURE FUN</span>
                </div>
            </section>

            <!-- ======== Блок Технических Деталей (Токеномика) ======== --><section id="tokenomics" class="bg-[#2a2a4e] p-6 md:p-8 rounded-2xl shadow-lg border-2 border-yellow-400 transform hover:scale-105 transition-transform duration-300">
                <h2 class="font-fredoka text-3xl md:text-4xl text-center mb-6 text-yellow-300">Technical Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 max-w-2xl mx-auto text-base md:text-lg">
                    <div class="bg-gray-800/50 p-4 rounded-lg flex justify-between items-center">
                        <span class="font-bold text-gray-400">Name:</span>
                        <span class="font-mono text-[#a8ff78]">DropAndPush</span>
                    </div>
                    <div class="bg-gray-800/50 p-4 rounded-lg flex justify-between items-center">
                        <span class="font-bold text-gray-400">Symbol:</span>
                        <span class="font-mono text-[#a8ff78]">$DNP</span>
                    </div>
                    <div class="bg-gray-800/50 p-4 rounded-lg flex justify-between items-center">
                        <span class="font-bold text-gray-400">Chain:</span>
                        <span class="font-mono text-[#a8ff78]">Ethereum</span>
                    </div>
                    <div class="bg-gray-800/50 p-4 rounded-lg flex justify-between items-center">
                        <span class="font-bold text-gray-400">Total supply:</span>
                        <span class="font-mono text-[#a8ff78]">1,000,000,000</span>
                    </div>
                </div>
            </section>

            <!-- ======== Дорожная карта (Roadmap) ======== --><section id="roadmap" class="bg-[#1e1e3f] p-6 md:p-8 rounded-2xl shadow-lg border-2 border-cyan-400 transform hover:scale-105 transition-transform duration-300">
                <h2 class="font-fredoka text-3xl md:text-4xl text-center mb-10 text-cyan-300">Roadmap: The Training Plan</h2>
                <!-- Mobile Roadmap --><div class="md:hidden space-y-8">
                    <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0 bg-cyan-500 w-10 h-10 rounded-full flex items-center justify-center font-black text-lg text-white">1</div>
                        <div>
                            <h3 class="font-bold text-white text-lg">Phase 1: The Warm-up</h3>
                            <p class="text-sm text-gray-300">Website & Socials Launch, Litepaper Release.</p>
                        </div>
                    </div>
                     <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0 bg-purple-500 w-10 h-10 rounded-full flex items-center justify-center font-black text-lg text-white">2</div>
                        <div>
                            <h3 class="font-bold text-white text-lg">Phase 2: Strength Building</h3>
                            <p class="text-sm text-gray-300">Community Growth, Meme Contests, Token Smart Contract Deployment.</p>
                        </div>
                    </div>
                     <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0 bg-cyan-500 w-10 h-10 rounded-full flex items-center justify-center font-black text-lg text-white">3</div>
                        <div>
                            <h3 class="font-bold text-white text-lg">Phase 3: Max Reps</h3>
                            <p class="text-sm text-gray-300">Public Token Sale, Listing on Uniswap, First Marketing Push.</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0 bg-purple-500 w-10 h-10 rounded-full flex items-center justify-center font-black text-lg text-white">4</div>
                        <div>
                            <h3 class="font-bold text-white text-lg">Phase 4: To the Moon!</h3>
                            <p class="text-sm text-gray-300">Listing on CoinGecko & CoinMarketCap, Influencer Collaborations.</p>
                        </div>
                    </div>
                </div>

                <!-- Desktop Roadmap --><div class="hidden md:block relative max-w-2xl mx-auto">
                    <div class="absolute left-1/2 top-0 h-full w-1 bg-gray-700/50 transform -translate-x-1/2"></div>
                    <div class="mb-8 flex justify-between items-center w-full right-timeline">
                        <div class="order-1 w-5/12"></div>
                        <div class="z-10 flex items-center order-1 bg-cyan-500 shadow-xl w-12 h-12 rounded-full">
                            <h1 class="mx-auto font-black text-lg text-white">1</h1>
                        </div>
                        <div class="order-1 bg-gray-800 rounded-lg shadow-xl w-5/12 px-6 py-4">
                            <h3 class="font-bold text-white text-xl">Phase 1: The Warm-up</h3>
                            <p class="text-sm leading-snug tracking-wide text-gray-300 text-opacity-100">Website & Socials Launch, Litepaper Release.</p>
                        </div>
                    </div>
                    <div class="mb-8 flex justify-between flex-row-reverse items-center w-full left-timeline">
                        <div class="order-1 w-5/12"></div>
                        <div class="z-10 flex items-center order-1 bg-purple-500 shadow-xl w-12 h-12 rounded-full">
                            <h1 class="mx-auto text-white font-black text-lg">2</h1>
                        </div>
                        <div class="order-1 bg-purple-800 rounded-lg shadow-xl w-5/12 px-6 py-4">
                            <h3 class="font-bold text-white text-xl">Phase 2: Strength Building</h3>
                            <p class="text-sm leading-snug tracking-wide text-gray-300 text-opacity-100">Community Growth, Meme Contests, Token Smart Contract Deployment.</p>
                        </div>
                    </div>
                     <div class="mb-8 flex justify-between items-center w-full right-timeline">
                        <div class="order-1 w-5/12"></div>
                        <div class="z-10 flex items-center order-1 bg-cyan-500 shadow-xl w-12 h-12 rounded-full">
                            <h1 class="mx-auto font-black text-lg text-white">3</h1>
                        </div>
                        <div class="order-1 bg-gray-800 rounded-lg shadow-xl w-5/12 px-6 py-4">
                            <h3 class="font-bold text-white text-xl">Phase 3: Max Reps</h3>
                            <p class="text-sm leading-snug tracking-wide text-gray-300 text-opacity-100">Public Token Sale, Listing on Uniswap, First Marketing Push.</p>
                        </div>
                    </div>
                    <div class="mb-8 flex justify-between flex-row-reverse items-center w-full left-timeline">
                        <div class="order-1 w-5/12"></div>
                        <div class="z-10 flex items-center order-1 bg-purple-500 shadow-xl w-12 h-12 rounded-full">
                            <h1 class="mx-auto text-white font-black text-lg">4</h1>
                        </div>
                        <div class="order-1 bg-purple-800 rounded-lg shadow-xl w-5/12 px-6 py-4">
                            <h3 class="font-bold text-white text-xl">Phase 4: To the Moon!</h3>
                            <p class="text-sm leading-snug tracking-wide text-gray-300 text-opacity-100">Listing on CoinGecko & CoinMarketCap, Influencer Collaborations.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ======== Блок Предзаказа (Call to Action) ======== --><section id="preorder" class="text-center bg-gradient-to-r from-green-400 to-yellow-500 p-8 md:p-10 rounded-2xl shadow-lg transform hover:scale-105 transition-transform duration-300">
                <h2 class="font-fredoka text-3xl md:text-5xl text-gray-900 mb-4">Pre-order DNP tokens now!</h2>
                <p class="text-lg md:text-xl text-gray-800 font-semibold mb-6">Join the movement, join the bounce!</p>
                <button class="bg-gray-900 text-white font-fredoka text-xl md:text-2xl px-10 py-3 md:px-12 md:py-4 rounded-full hover:bg-black transform hover:rotate-[-5deg] transition-all duration-300 glow-effect">
                    GET $DNP
                </button>
            </section>
        </main>

        <!-- ======== Футер и Контакты ======== --><footer class="text-center mt-12 md:mt-16 py-8">
            <h3 class="font-fredoka text-xl md:text-2xl mb-4 text-gray-300">Find us here:</h3>
            <div class="flex justify-center space-x-6">
                <!-- Telegram --><a href="https://t.me/DropNpushCoin" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transform hover:scale-125 transition-transform">
                    <svg class="w-8 h-8 md:w-10 md:h-10" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M9.78 18.65l.28-4.23l7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3L3.64 12c-.88-.25-.89-.86.2-1.3l15.97-6.16c.73-.33 1.43.18 1.15 1.3l-2.72 12.81c-.19.91-.74 1.13-1.51 .71l-4.84-3.56l-2.31 2.24c-.25.24-.45.44-.88.44l.28-4.23z"/></svg>
                </a>
                <!-- Email --><a href="mailto:dnp.official.contact@proton.me" class="text-gray-400 hover:text-white transform hover:scale-125 transition-transform">
                    <svg class="w-8 h-8 md:w-10 md:h-10" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z"/></svg>
                </a>
            </div>
            <p class="text-xs md:text-sm text-gray-500 mt-8">&copy; 2025 DropAndPush Coin. All rights reserved. For entertainment purposes only.</p>
        </footer>
    </div>
    
    <!-- Profile Modal --><div id="profile-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4">
        <div class="bg-[#2a2a4e] p-6 md:p-8 rounded-2xl shadow-lg w-full max-w-md border-2 border-green-400 relative">
             <button class="close-modal-btn absolute top-2 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h2 class="font-fredoka text-2xl md:text-3xl text-center mb-4 text-white">Your Profile</h2>
            <div id="profile-content">
                 <div class="mb-4">
                    <label class="block text-gray-300 mb-2">Connected Wallet</label>
                    <p id="profile-wallet" class="text-lg text-green-400 font-mono break-words bg-gray-800/50 p-3 rounded-lg"></p>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-300 mb-2">Total Score</label>
                    <p id="profile-score" class="text-2xl font-fredoka text-yellow-300"></p>
                </div>
                 <div class="mt-6">
                    <label class="block text-gray-300 mb-2">Your Referral Link</label>
                    <div class="flex">
                        <input id="ref-link-input" type="text" readonly class="w-full bg-gray-800 border border-gray-700 rounded-l-lg p-2 text-gray-400 text-sm">
                        <button id="copy-ref-link-btn" class="bg-green-500 hover:bg-green-600 px-3 rounded-r-lg text-white">Copy</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Overlay --><div id="game-overlay" class="hidden fixed inset-0 z-[100] bg-black/80 flex items-center justify-center p-4">
        <div id="game-viewport" class="relative w-full shadow-2xl" style="aspect-ratio: 9 / 16; max-height: 90vh; max-width: calc(90vh * 9 / 16);">
            <!-- Game UI --><div class="absolute top-5 left-5 z-10">
                <button id="close-game-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">Exit</button>
            </div>
            <div class="absolute top-5 right-5 z-10 bg-black/50 p-2 rounded-lg flex items-center space-x-2">
                <button id="sound-toggle-btn" class="text-white">
                    <!-- Sound On Icon --><svg id="sound-on-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M7 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zM13 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1z"></path></svg>
                    <!-- Sound Off Icon --><svg id="sound-off-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path></svg>
                </button>
                <img src="images/gold.png" alt="Coin" class="w-8 h-8">
                <span id="game-score" class="font-fredoka text-2xl text-yellow-300">0</span>
            </div>

            <!-- Game Area --><div id="candle-char-container" class="w-full h-full flex items-end justify-center pb-[10%] relative">
                 <!-- Power Bar --><div class="absolute left-[8%] bottom-[20%] h-[35%] w-10 bg-gray-900/50 rounded-full border-2 border-gray-500 flex flex-col-reverse overflow-hidden">
                    <div id="power-bar-fill" class="w-full bg-gradient-to-t from-red-500 via-yellow-500 to-green-500" style="height: 0%;"></div>
                </div>
                
                <img id="candle-char" src="images/fire_red.png" alt="Candle Character" class="h-[34%]">
                <div id="floating-text-container" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none w-full h-full"></div>
            </div>
        </div>
    </div>

    <!-- Daily Bonus Modal --><div id="daily-bonus-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center modal-backdrop p-4">
        <div class="bg-gradient-to-br from-purple-800 to-indigo-900 p-6 rounded-2xl shadow-lg text-center text-white bonus-popup-animation w-full max-w-md border-2 border-yellow-400">
            <h2 class="font-fredoka text-3xl text-yellow-300">Daily Login Streak</h2>
            <p class="mt-2 text-gray-300">Log in every day to get bigger rewards!</p>
            <div id="streak-grid" class="grid grid-cols-4 gap-2 mt-6">
                <!-- Day items will be injected here -->
            </div>
            <button id="claim-bonus-btn" class="mt-6 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition disabled:bg-gray-500 disabled:cursor-not-allowed">
                Claim Bonus
            </button>
        </div>
    </div>
    
    <audio id="background-music" loop src="sound/sound.mp3"></audio>


    <!-- Firebase and App Logic --><script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signOut, 
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            updateDoc,
            increment,
            onSnapshot,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIG OBJECT HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAWgflsjln12yVOQZInvFql97bFHs8aO7c",
            authDomain: "dropandpush-coin.firebaseapp.com",
            projectId: "dropandpush-coin",
            storageBucket: "dropandpush-coin.firebasestorage.app",
            messagingSenderId: "414577803061",
            appId: "1:414577803061:web:1e44ab43730ebb0702967c"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI Elements
        const connectWalletBtn = document.getElementById('connect-wallet-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const profileBtn = document.getElementById('profile-btn');
        
        const authLinks = document.getElementById('auth-links');
        const userProfile = document.getElementById('user-profile');
        const userDisplay = document.getElementById('user-display');
        const gameSection = document.getElementById('game-section');

        const profileModal = document.getElementById('profile-modal');
        const refLinkInput = document.getElementById('ref-link-input');
        const copyRefLinkBtn = document.getElementById('copy-ref-link-btn');
        
        const dailyBonusModal = document.getElementById('daily-bonus-modal');
        const streakGrid = document.getElementById('streak-grid');
        const claimBonusBtn = document.getElementById('claim-bonus-btn');

        
        // Game Elements
        const startGameBtn = document.getElementById('start-game-btn');
        const gameOverlay = document.getElementById('game-overlay');
        const closeGameBtn = document.getElementById('close-game-btn');
        const candleCharContainer = document.getElementById('candle-char-container');
        const candleChar = document.getElementById('candle-char');
        const gameScoreDisplay = document.getElementById('game-score');
        const floatingTextContainer = document.getElementById('floating-text-container');
        const powerBarFill = document.getElementById('power-bar-fill');
        const soundToggleBtn = document.getElementById('sound-toggle-btn');
        const soundOnIcon = document.getElementById('sound-on-icon');
        const soundOffIcon = document.getElementById('sound-off-icon');
        const backgroundMusic = document.getElementById('background-music');

        let currentUser = null;
        let userDocRef = null;
        let scoreUnsubscribe = null; 
        let isSoundOn = false;

        const bonuses = [10, 20, 30, 40, 50, 60, 100]; // Day 1 to 7

        // --- Referral Logic ---
        function handleReferral() {
            const urlParams = new URLSearchParams(window.location.search);
            const refId = urlParams.get('ref');
            if (refId) {
                localStorage.setItem('referralId', refId);
            }
        }
        handleReferral();


        // --- Modal & Overlay Logic ---
        function showModal(modal) { modal.classList.remove('hidden'); }
        function hideModal(modal) { modal.classList.add('hidden'); }

        startGameBtn.addEventListener('click', () => {
            gameOverlay.classList.remove('hidden');
            startGameLoop();
        });
        closeGameBtn.addEventListener('click', () => {
            gameOverlay.classList.add('hidden');
            stopGameLoop();
        });

        profileBtn.addEventListener('click', async () => {
            if (!currentUser) return;
            
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('profile-wallet').textContent = data.wallet || 'N/A';
                document.getElementById('profile-score').textContent = data.score || 0;
                refLinkInput.value = `${window.location.origin}${window.location.pathname}?ref=${data.wallet.toLowerCase()}`;
            }
            showModal(profileModal);
        });

        copyRefLinkBtn.addEventListener('click', () => {
            refLinkInput.select();
            document.execCommand('copy');
            copyRefLinkBtn.textContent = 'Copied!';
            setTimeout(() => { copyRefLinkBtn.textContent = 'Copy'; }, 2000);
        });
        
        document.querySelectorAll('.modal-backdrop, .close-modal-btn').forEach(el => {
            el.addEventListener('click', (e) => {
                 if (e.target.classList.contains('close-modal-btn')) {
                    el.closest('.modal-backdrop').classList.add('hidden');
                }
            })
        });

        // --- Wallet Logic ---
        const isMobile = () => /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        function formatAddress(address) {
            if (!address) return '';
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        connectWalletBtn.addEventListener('click', async () => {
            if (isMobile() && !window.ethereum) {
                const metamaskAppDeepLink = "https://metamask.app.link/dapp/" + window.location.host;
                window.location.href = metamaskAppDeepLink;
                return;
            }

            if (typeof window.ethereum === 'undefined') {
                alert('MetaMask is not installed. Please install it to use this feature.');
                return;
            }
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const walletAddress = accounts[0].toLowerCase();
                localStorage.setItem('connectedWallet', walletAddress);
                
                // Sign out any anonymous user before signing in with a new identity
                if (auth.currentUser && auth.currentUser.isAnonymous) {
                    await signOut(auth);
                }
                
                // Now handle login with the specific wallet address
                await handleLogin(walletAddress);

            } catch (error) {
                 console.error("Wallet connection failed:", error);
                if (error.code === 4001) {
                    alert('Connection request rejected. Please approve the request in MetaMask to connect your wallet.');
                } else {
                    alert(`Failed to connect wallet. Please see console for details.`);
                }
            }
        });

        // --- Sound Logic ---
        function toggleSound() {
            isSoundOn = !isSoundOn;
            if (isSoundOn) {
                backgroundMusic.play().catch(e => console.log("Audio play failed", e));
                soundOnIcon.classList.remove('hidden');
                soundOffIcon.classList.add('hidden');
            } else {
                backgroundMusic.pause();
                soundOnIcon.classList.add('hidden');
                soundOffIcon.classList.remove('hidden');
            }
        }
        soundToggleBtn.addEventListener('click', toggleSound);


        // --- Game Logic ---
        let powerLevel = 0;
        const MAX_POWER = 100;
        const POWER_PER_TAP = 10;
        const POWER_DECREASE_RATE = 1;
        let gameLoopInterval = null;
        let idleTimer = null;
        let lastClickTime = 0;
        
        const candleStates = ['images/fire_red.png', 'images/fire_yellow.png', 'images/fire_green.png'];
        const motivationPhrases = ["Come on, bro!", "One more rep?", "Don't be weak!", "Push harder!"];

        function showMotivationPopup() {
            const phrase = motivationPhrases[Math.floor(Math.random() * motivationPhrases.length)];
            const popup = document.createElement('div');
            popup.textContent = phrase;
            popup.className = 'font-fredoka text-2xl text-white absolute top-[40%] left-1/2 -translate-x-1/2 motivation-animation';
            floatingTextContainer.appendChild(popup);
            setTimeout(() => popup.remove(), 4000);
        }

        function resetIdleTimer() {
            clearTimeout(idleTimer);
            idleTimer = setTimeout(showMotivationPopup, 10000); // 10 seconds
        }

        function updateGameUI() {
            powerBarFill.style.height = `${powerLevel}%`;

            if (powerLevel < 40) candleChar.src = candleStates[0];
            else if (powerLevel < 80) candleChar.src = candleStates[1];
            else candleChar.src = candleStates[2];
        }

        function startGameLoop() {
            if (gameLoopInterval) return;
            if (isSoundOn) {
                backgroundMusic.play().catch(e => console.log("Audio play failed", e));
            }
            resetIdleTimer();
            gameLoopInterval = setInterval(() => {
                powerLevel = Math.max(0, powerLevel - POWER_DECREASE_RATE);
                updateGameUI();
            }, 50);
        }

        function stopGameLoop() {
            clearInterval(gameLoopInterval);
            clearTimeout(idleTimer);
            gameLoopInterval = null;
            idleTimer = null;
            powerLevel = 0;
            updateGameUI();
            backgroundMusic.pause();
        }
        
        candleCharContainer.addEventListener('click', async () => {
            if (!currentUser) return;

            const now = Date.now();
            if (now - lastClickTime < 50) { // Anti-autoclicker: 50ms cooldown
                return;
            }
            lastClickTime = now;

            resetIdleTimer();

            powerLevel = Math.min(MAX_POWER, powerLevel + POWER_PER_TAP);

            if (powerLevel >= MAX_POWER) {
                powerLevel = 0;

                try {
                    await updateDoc(userDocRef, { score: increment(1) });
                
                    const plusOne = document.createElement('div');
                    plusOne.textContent = "+1";
                    plusOne.className = 'font-fredoka text-3xl text-yellow-300 absolute top-1/2 left-1/2 -translate-x-1/2 plus-one-animation';
                    floatingTextContainer.appendChild(plusOne);
                    setTimeout(() => plusOne.remove(), 1000);

                } catch (error) {
                    console.error("Error updating score:", error);
                }
            }
            updateGameUI();
        });


        // --- Auth State Logic ---
        async function handleLogin(walletAddress) {
            userDocRef = doc(db, "users", walletAddress);
            const docSnap = await getDoc(userDocRef);

            if (!docSnap.exists()) {
                // New user flow
                const referralId = localStorage.getItem('referralId');
                await setDoc(userDocRef, {
                    wallet: walletAddress,
                    score: 0,
                    createdAt: serverTimestamp(),
                    lastLogin: serverTimestamp(),
                    loginStreak: 1,
                    referredBy: referralId || null,
                });

                if (referralId && referralId !== walletAddress) {
                    const referrerDocRef = doc(db, "users", referralId);
                    const referrerDoc = await getDoc(referrerDocRef);
                    if (referrerDoc.exists()) {
                        await updateDoc(referrerDocRef, { score: increment(50) });
                    }
                }
                localStorage.removeItem('referralId');
                
                // Show welcome bonus
                updateStreakUI(1, true);
                showModal(dailyBonusModal);

            } else {
                // Existing user flow
                await checkForDailyBonus(docSnap);
            }

            setupUserSession(walletAddress);
        }
        
        function setupUserSession(walletAddress) {
            currentUser = { uid: walletAddress }; // simplified user object
            userDocRef = doc(db, "users", walletAddress);

             if (scoreUnsubscribe) scoreUnsubscribe();
            
            scoreUnsubscribe = onSnapshot(userDocRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    userDisplay.textContent = formatAddress(data.wallet);
                    gameScoreDisplay.textContent = data.score || 0;

                    authLinks.classList.add('hidden');
                    userProfile.classList.remove('hidden');
                    userProfile.classList.add('flex');
                    gameSection.classList.remove('hidden');
                }
            });
        }

        async function checkForDailyBonus(userDoc) {
            const userData = userDoc.data();
            const lastLogin = userData.lastLogin?.toDate();
            let streak = userData.loginStreak || 0;
            const now = new Date();
            
            if (!lastLogin) return;
            
            const lastLoginDate = new Date(lastLogin.getFullYear(), lastLogin.getMonth(), lastLogin.getDate());
            const todayDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            const diffTime = todayDate.getTime() - lastLoginDate.getTime();
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
            
            let canClaim = false;
            if (diffDays === 1) { // Continued streak
                streak = (streak >= 7) ? 1 : streak + 1;
                canClaim = true;
            } else if (diffDays > 1) { // Streak broken
                streak = 1;
                canClaim = true;
            } // if diffDays is 0, they already logged in today.
            
            updateStreakUI(streak, canClaim);
            if(canClaim) {
                showModal(dailyBonusModal);
            }
        }
        
        function updateStreakUI(streak, canClaim) {
            streakGrid.innerHTML = '';
            for (let i = 1; i <= 7; i++) {
                const dayDiv = document.createElement('div');
                const dayText = document.createElement('p');
                dayText.textContent = `Day ${i}`;
                dayText.className = 'font-bold';
                const rewardText = document.createElement('p');
                rewardText.textContent = `+${bonuses[i-1]}`;
                rewardText.className = 'text-yellow-300 font-fredoka text-lg';

                dayDiv.appendChild(dayText);
                dayDiv.appendChild(rewardText);
                dayDiv.className = 'p-2 rounded-lg';

                if (i < streak) {
                    dayDiv.classList.add('bg-green-700/50', 'opacity-60');
                    dayText.textContent += ' ✅';
                } else if (i === streak && canClaim) {
                    dayDiv.classList.add('bg-yellow-500', 'ring-2', 'ring-white');
                } else {
                     dayDiv.classList.add('bg-gray-700/50');
                }
                streakGrid.appendChild(dayDiv);
            }
            claimBonusBtn.disabled = !canClaim;
            claimBonusBtn.textContent = canClaim ? 'Claim Bonus' : 'Already Claimed';
        }

        claimBonusBtn.addEventListener('click', async () => {
            if (!userDocRef) return;
            claimBonusBtn.disabled = true;
            
            const userDoc = await getDoc(userDocRef);
            const streak = userDoc.data().loginStreak || 1;
            const bonusAmount = bonuses[streak - 1];

            await updateDoc(userDocRef, {
                score: increment(bonusAmount),
                lastLogin: serverTimestamp(),
                loginStreak: streak
            });
            hideModal(dailyBonusModal);
        });

        // Check on page load if a wallet was previously connected
        window.addEventListener('load', async () => {
            const connectedWallet = localStorage.getItem('connectedWallet');
            if (connectedWallet) {
                await handleLogin(connectedWallet);
            }
        });


        // Logout
        logoutBtn.addEventListener('click', async () => {
            localStorage.removeItem('connectedWallet');
            currentUser = null;
            userDocRef = null;
            if (scoreUnsubscribe) scoreUnsubscribe();
            
            authLinks.classList.remove('hidden');
            userProfile.classList.add('hidden');
            userProfile.classList.remove('flex');
            gameSection.classList.add('hidden');
            stopGameLoop();
        });

    </script>

</body>
</html>

